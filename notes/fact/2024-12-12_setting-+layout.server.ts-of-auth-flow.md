---
date: 2024-12-12
type: fact
aliases:
  -
hubs:
  - "[[sv5]]"
---

# setting +layout.server.ts of auth flow

In this topic, we start to implement the third step of [[2024-12-09_Svelte-Auth-Request-Flow|Svelte Auth Request Flow]], which is to pass the session and cookie generated by `hooks.server.ts` to `+layout.ts`.

We can simply copy paste the code from [Supabase documentation](https://supabase.com/docs/guides/auth/server-side/sveltekit) - step 5 and 2nd tap.

```typescript
// src/routes/+layout.server.ts (new file)

import type { LayoutServerLoad } from './$types'

export const load: LayoutServerLoad = async ({ locals: { safeGetSession }, cookies }) => {
                                                      // ^^^^^^^^^^^^^^ come from hooks.server.ts

  const { session } = await safeGetSession() // generate session safely

  // and pass the session and cookies to the layout.ts (next step)
  return {
    session,
    cookies: cookies.getAll(),
  }
}

```

Let's check the place of hooks.server.ts in the auth flow:

```typescript
// src/hooks.server.ts

const supabase: Handle = async ({ event, resolve }) => {

  event.locals.safeGetSession = async () => {
//^^^^^^^^^^^^^^^^^^^^^^^^^^^ event is nothing more than request object,
//                            so we can get `safeGetSession` in `+layout.server.ts` easily.
    const {
      data: { session },
    } = await event.locals.supabase.auth.getSession()
    if (!session) {
      return { session: null, user: null }
    }

    const {
      data: { user },
      error,
    } = await event.locals.supabase.auth.getUser()
    if (error) {
      // JWT validation has failed
      return { session: null, user: null }
    }

    return { session, user }
  }

```
